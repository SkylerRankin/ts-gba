<!DOCTYPE html>
<html>
    <head>
        <script src="./tsgba.js"></script>
        <style>
            * {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            #container { width: 1000px; margin: 50px auto; }
            #canvas_container canvas { position: absolute; image-rendering: pixelated; background-color: #e1e1e1; }
            #game_control_container { margin-bottom: 10px; }
            #game_control_container > div { margin-right: 20px; }
            #key_container > div { margin-bottom: 10px; }
            #key_container > table { width: 100%; border-collapse: collapse; }
            #title_link { color: #0398fc; text-decoration: none; font-size: 20px; font-weight: bold; }
            #tab_container { width: 480px; display: inline-block; min-height: 320px; font-size: 12px; }
            #tab_row { margin-bottom: 30px; display: flex; font-size: 16px; }
            #step_button_container { margin-bottom: 10px; display: flex; justify-content: space-between; }
            #step_button_container > div { flex-grow: 1; }
            #step_button_container > div + div { margin-left: 20px; }
            #instruction_table { width: 100%; }
            #instruction_table, #instruction_table > tr, #instruction_table > tr > td { border-collapse: collapse; }
            #registers_table_container, #instruction_table_container, #key_container {
                padding: 5px;
                border: solid 1px #969696;
                border-radius: 3px;
                margin-bottom: 10px;
            }
            #registers_table { width: 100%; }
            #registers_table, #registers_table > tr, #registers_table > tr > td { border-collapse: collapse; }
            #instruction_jump_container { display: flex; margin-bottom: 10px; }
            #instruction_jump_container > div { flex-grow: 1; margin-left: 20px; text-align: center; }
            #instruction_jump_container > input { border: solid 1px #969696; border-radius: 3px; }

            .hidden { display: none; }
            .tab {
                border-bottom: solid 1px #969696;
                width: 100px;
                color: #969696;
                cursor: pointer;
                text-align: left;
                padding-left: 5px;
                width: 80px;
                margin-right: 20px;
            }
            .tab_selected { color: #000; font-weight: bold; }
            .button {
                display: inline-block;
                border: solid 1px #969696;
                border-radius: 3px;
                text-align: center;
                line-height: 20px;
                cursor: pointer;
                width: 80px;
                height: 20px;
                font-size: 12px;
            }
            .button:hover { background-color: #cccccc; }
            .instruction_table_pc_row { background-color: #5996f7; }
            .instruction_table_breakpoint_row { font-weight: bold; color: #942b2b; }
            .cpsr_flag { color: #e1e1e1; }
            .cpsr_flag_active { color: black; font-weight: bold; }

        </style>

        <script>
            let gba = null;
            let romLoaded = false;
            let running = false;

            let instructionTableState = {
                pcOffset: 0,
                checkScroll: true,
                activeAddress: 0,
                lastClickedRowAddress: 0,
                lastClickedRowTime: 0,
                doubleClickMs: 400,
            };

            const keyCodeToKey = {
                219: "A",
                221: "B",
                13: "Select",
                16: "Start",
                68: "Right",
                39: "Right",
                65: "Left",
                37: "Left",
                87: "Up",
                38: "Up",
                83: "Down",
                40: "Down",
                76: "L",
                82: "R"
            };

            const onTabSelect = (tabIndex) => {
                for (let i = 0; i < 3; i++) {
                    const tab = document.getElementById(`tab${i}`);
                    const tabContainer = document.getElementById(`tab${i}_container`);
                    if (i === tabIndex) {
                        tab.classList.add('tab_selected');
                        tabContainer.classList.remove('hidden');

                    } else {
                        tab.classList.remove('tab_selected');
                        tabContainer.classList.add('hidden');
                    }
                }
            }

            const onROMUpload = (event) => {
                if (!event.files || !event.files[0]) {
                    console.error(`No ROM file uploaded.`);
                    return;
                }
                const fileReader = new FileReader();
                fileReader.onloadend = event => {
                    if (fileReader.result !== null) {
                        const buffer = new Uint8Array(fileReader.result);
                        gba.reset();
                        gba.loadROM(buffer);
                        romLoaded = true;
                        console.log(`ROM loaded`);
                        onPause();
                    }
                };
                fileReader.readAsArrayBuffer(event.files[0]);
            }

            const onRun = () => {
                instructionTableState.pcOffset = 0;
                document.getElementById("cpu_info_warning").classList.remove("hidden");
                document.getElementById("cpu_info_container").classList.add("hidden");
                romLoaded = true;
                gba.run();
            }

            const onPause = () => {
                gba.pause();
                document.getElementById("cpu_info_warning").classList.add("hidden");
                document.getElementById("cpu_info_container").classList.remove("hidden");

                // Focus instruction list on PC on pause
                instructionTableState.activeAddress = gba.cpu.getGeneralRegister(15) - gba.cpu.instructionSize * 2;
                updateInstructionList();
                updateRegisters();
            }

            const onReset = () => {
                gba.reset();
                document.getElementById("cpu_info_warning").classList.add("hidden");
                document.getElementById("cpu_info_container").classList.remove("hidden");
                romLoaded = false;
            }

            const onStep = () => {
                gba.runStep();
                instructionTableState.activeAddress = gba.cpu.getGeneralRegister(15) - gba.cpu.instructionSize * 2;
                instructionTableState.pcOffset = 0;
                updateInstructionList();
                updateRegisters();
            }

            const onSelectRow = () => {
                const address = instructionTableState.lastClickedRowAddress;
                if (gba.cpu.breakpoints.has(address)) {
                    gba.cpu.removeBreakpoint(address);
                } else {
                    gba.cpu.setBreakpoint(address);
                }
                updateInstructionList();
            }

            const updateRegisters = () => {
                const text = window.UI.getRegisterText(gba);

                Object.entries(text).forEach(([key, text]) => {
                    if (key.startsWith("r")) {
                        document.getElementById(`${key}_value`).innerHTML = text;
                    } else if (key === "cpsr") {
                        document.getElementById("cpsr_value").innerHTML = text;
                    } else if (key.startsWith("flag_")) {
                        if (text === "true") {
                            document.getElementById(key).classList.add("cpsr_flag_active");
                        } else {
                            document.getElementById(key).classList.remove("cpsr_flag_active");
                        }
                    }
                });
            }

            const updateInstructionList = () => {
                const pc = gba.cpu.getGeneralRegister(15) - gba.cpu.instructionSize * 2;
                const lines = window.UI.getInstructionTableLines(instructionTableState.activeAddress + instructionTableState.pcOffset * gba.cpu.instructionSize, 11, gba);

                const table = document.getElementById("instruction_table");
                table.replaceChildren([]);
                lines.forEach(line => {
                    const tr = document.createElement("tr");
                    if (line.address === pc) {
                        tr.classList.add("instruction_table_pc_row");
                    }

                    if (gba.cpu.breakpoints.has(line.address)) {
                        tr.classList.add("instruction_table_breakpoint_row");
                    }

                    tr.addEventListener("click", () => {
                        if (instructionTableState.lastClickedRowAddress === line.address) {
                            if (performance.now() - instructionTableState.lastClickedRowTime < instructionTableState.doubleClickMs) {
                                onSelectRow();
                            }
                        } else {
                            instructionTableState.lastClickedRowAddress = line.address;
                        }
                        instructionTableState.lastClickedRowTime = performance.now();
                    });

                    const address = document.createElement("td");
                    address.innerHTML = `0x${line.address.toString(16).padStart(8, '0')}`;
                    address.style = "width: 20%;";

                    const instruction = document.createElement("td");
                    instruction.innerHTML = `0x${line.instruction.toString(16).padStart(gba.cpu.operatingState === "ARM" ? 8 : 4, '0')}`;
                    instruction.style = "width: 20%;";

                    const text = document.createElement("td");
                    text.innerHTML = line.text.toLowerCase();
                    text.style = "width: 50%;";

                    tr.appendChild(address);
                    tr.appendChild(instruction);
                    tr.appendChild(text);
                    table.appendChild(tr);
                });
            }

            const onKeyUpdate = (key, pressed) => {
                const gbaKey = keyCodeToKey[key];
                if (gbaKey) {
                    if (pressed) gba.keypad.onKeyDown(gbaKey);
                    else gba.keypad.onKeyUp(gbaKey);
                }
            }

            window.onload = () => {
                gba = new window.GBA();
                gba.reset();

                document.getElementById("startButton").onclick = () => {
                    if (romLoaded) {
                        onRun();
                    } else {
                        console.warn("No rom loaded");
                    }
                };
                document.getElementById("resetButton").onclick = () => { onReset(); };
                document.getElementById("instruction_table").addEventListener("wheel", (event) => {
                    if (!instructionTableState.checkScroll) return;
                    instructionTableState.pcOffset += Math.sign(event.wheelDeltaY) * -1;
                    requestAnimationFrame(() => {
                        updateInstructionList();
                        instructionTableState.checkScroll = true;
                    });
                    instructionTableState.checkScroll = false;
                });

                document.getElementById("debug_reset_button").addEventListener("click", () => { onReset(); });
                document.getElementById("debug_run_button").addEventListener("click", () => { onRun(); });
                document.getElementById("debug_pause_button").addEventListener("click", () => { onPause(); });
                document.getElementById("debug_step_button").addEventListener("click", () => { onStep(); });
                document.getElementById("instruction_jump_button").addEventListener("click", () => {
                    let addressText = document.getElementById("instruction_jump_input").value;
                    if (!addressText.startsWith("0x")) addressText = "0x" + addressText;
                    const address = Number.parseInt(addressText);
                    const instructionSize = gba.cpu.operatingState === "ARM" ? 4 : 2;
                    instructionTableState.pcOffset = (address - instructionTableState.activeAddress) / instructionSize;
                    updateInstructionList();
                });
                document.getElementById("instruction_pc_button").addEventListener("click", () => {
                    instructionTableState.pcOffset = 0;
                    updateInstructionList();
                });

                gba.cpu.breakpointCallback = () => {
                    onPause();
                }

                document.addEventListener("keydown", (event) => { onKeyUpdate(event.keyCode, true); });
                document.addEventListener("keyup", (event) => { onKeyUpdate(event.keyCode, false); });

            }
        </script>
    </head>
    <body>
        <div id="container">
            <div style="margin-bottom: 20px;">
                <a href="https://github.com/SkylerRankin/ts-gba" id="title_link">ts-gba</a>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <div id="canvas_container">
                    <canvas id="frame_0_canvas" width="480px" height="320px" tabindex="0"></canvas>
                    <canvas id="frame_1_canvas" width="480px" height="320px" tabindex="0" class="hidden"></canvas>
                </div>
                <div id="tab_container">
                    <div id="tab_row">
                        <div id="tab0" class="tab tab_selected" onclick="onTabSelect(0)">Game</div>
                        <div id="tab1" class="tab" onclick="onTabSelect(1)">CPU</div>
                        <div id="tab2" class="tab" onclick="onTabSelect(2)">PPU</div>
                    </div>
                    <div id="tab0_container" class="">
                        <div id="game_control_container">
                            <input id="romInput" type="file" style="display: none !important;" onChange="onROMUpload(this)">
                            <div class="button" id='uploadButton' onClick="document.getElementById('romInput').click()"}>Upload ROM</div>
                            <div class="button" id="startButton">Start</div>
                            <div class="button" id="resetButton">Reset</div>
                        </div>
                        <div id="key_container">
                            <div>Controls</div>
                            <table>
                                <tr>
                                    <td>A Button</td>
                                    <td>[</td>
                                    <td>Right Button</td>
                                    <td>D / Right</td>
                                    <td>L Button</td>
                                    <td>L</td>
                                </tr>
                                <tr>
                                    <td>B Button</td>
                                    <td>]</td>
                                    <td>Left Button</td>
                                    <td>A / Left</td>
                                    <td>R Button</td>
                                    <td>R</td>
                                </tr>
                                <tr>
                                    <td>Select</td>
                                    <td>Enter</td>
                                    <td>Up Button</td>
                                    <td>W / Up</td>
                                </tr>
                                <tr>
                                    <td>Start</td>
                                    <td>Shift</td>
                                    <td>Down Button</td>
                                    <td>S / Down</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div id="tab1_container" class="hidden">
                        <div id="step_button_container">
                            <div class="button" id="debug_reset_button">Reset</div>
                            <div class="button" id="debug_run_button">Run</div>
                            <div class="button" id="debug_pause_button">Pause</div>
                            <div class="button" id="debug_step_button">Step</div>
                        </div>
                        <div id="cpu_info_container" class="hidden">
                            <div id="registers_table_container">
                                <table id="registers_table">
                                    <tr>
                                        <td>R0</td>
                                        <td id="r0_value">00000000</td>
                                        <td>R8</td>
                                        <td id="r8_value">00000000</td>
                                        <td>CPSR</td>
                                        <td id="cpsr_value">00000000</td>
                                    </tr>
                                    <tr>
                                        <td>R1</td>
                                        <td id="r1_value">00000000</td>
                                        <td>R9</td>
                                        <td id="r9_value">00000000</td>
                                        <td>Flags</td>
                                        <td>
                                            <span id="flag_n" class="cpsr_flag">n</span>
                                            <span id="flag_z" class="cpsr_flag">z</span>
                                            <span id="flag_c" class="cpsr_flag">c</span>
                                            <span id="flag_v" class="cpsr_flag">v</span>
                                            <span id="flag_i" class="cpsr_flag">i</span>
                                            <span id="flag_f" class="cpsr_flag">f</span>
                                            <span id="flag_t" class="cpsr_flag">t</span>
                                            <span id="flag_q" class="cpsr_flag">q</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>R2</td>
                                        <td id="r2_value">00000000</td>
                                        <td>R10</td>
                                        <td id="r10_value">00000000</td>
                                    </tr>
                                    <tr>
                                        <td>R3</td>
                                        <td id="r3_value">00000000</td>
                                        <td>R11</td>
                                        <td id="r11_value">00000000</td>
                                    </tr>
                                    <tr>
                                        <td>R4</td>
                                        <td id="r4_value">00000000</td>
                                        <td>R12</td>
                                        <td id="r12_value">00000000</td>
                                    </tr>
                                    <tr>
                                        <td>R5</td>
                                        <td id="r5_value">00000000</td>
                                        <td>R13</td>
                                        <td id="r13_value">00000000</td>
                                    </tr>
                                    <tr>
                                        <td>R6</td>
                                        <td id="r6_value">00000000</td>
                                        <td>R14</td>
                                        <td id="r14_value">00000000</td>
                                    </tr>
                                    <tr>
                                        <td>R7</td>
                                        <td id="r7_value">00000000</td>
                                        <td>R15</td>
                                        <td id="r15_value">00000000</td>
                                    </tr>
                                </table>
                            </div>
                            <div id="instruction_table_container">
                                <table id="instruction_table"></table>
                            </div>
                            <div id="instruction_jump_container">
                                <input id="instruction_jump_input" type="text" value="08000000">
                                <div class="button" id="instruction_jump_button">Jump</div>
                                <div class="button" id="instruction_pc_button">Return to PC</div>
                            </div>
                            <div style>
                                <div>Debugger notes:</div>
                                <ul style="margin-top: 0px;">
                                    <li>Double click instruction to set breakpoint, will be highlighted in red</li>
                                    <li>Current PC is highlighted in blue</li>
                                    <li>All instructions in table are decoded according to current operating state, may not be correct</li>
                                </ul>
                            </div>
                        </div>
                        <div id="cpu_info_warning" class="hidden">Not updated while emulator is running</div>
                    </div>
                    <div id="tab2_container" class="hidden">
                        tab 2, empty
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

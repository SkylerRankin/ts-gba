<!DOCTYPE html>
<html>
    <head>
        <script src="./tsgba.js"></script>
        <style>
            * {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            #container {
                width: 1000px;
                margin: 50px auto;
            }

            #canvas_container canvas {
                position: absolute;
                image-rendering: pixelated;
                background-color: #e1e1e1;
            }

            .hidden {
                display: none;
            }

            .canvas_hidden {
                display: none;
            }

            #tab_container {
                width: 480px;
                display: inline-block;
                min-height: 320px;
            }

            #tab_row {
                margin-bottom: 20px;
                display: flex;
            }

            .tab {
                box-sizing: border-box;
                width: 50px;
                color: #9c9c9c;
                font-weight: bold;
                cursor: pointer;
                text-align: center;
            }

            .tab_selected {
                color: black;
            }

            .tab_hidden {
                display: none;
            }

            .tab_content {
                /* background-color: #e1e1e1; */
            }

            .button {
                display: inline-block;
                background-color: aquamarine;
                border-radius: 5px;
                text-align: center;
                line-height: 20px;
                cursor: pointer;
                width: 80px;
                height: 20px;
                font-size: 10px;
            }

            .button:hover {
                background-color: aqua;
            }

            #instruction_table {
                width: 100%;
            }

            #instruction_table, #instruction_table > tr, #instruction_table > tr > td {
                border: 1px solid #e1e1e1;
                border-collapse: collapse;
            }

        </style>

        <script>
            let gba = null;
            let romLoaded = false;
            let running = false;

            let instructionTableState = {
                pcOffset: 0,
                checkScroll: true,
                activeAddress: 0
            };

            const onTabSelect = (tabIndex) => {
                for (let i = 0; i < 3; i++) {
                    const tab = document.getElementById(`tab${i}`);
                    const tabContainer = document.getElementById(`tab${i}_container`);
                    if (i === tabIndex) {
                        tab.classList.add('tab_selected');
                        tabContainer.classList.remove('tab_hidden');

                    } else {
                        tab.classList.remove('tab_selected');
                        tabContainer.classList.add('tab_hidden');
                    }
                }
            }

            const onROMUpload = (event) => {
                if (!event.files || !event.files[0]) {
                    console.error(`No ROM file uploaded.`);
                    return;
                }
                const fileReader = new FileReader();
                fileReader.onloadend = event => {
                    if (fileReader.result !== null) {
                        const buffer = new Uint8Array(fileReader.result);
                        gba.reset();
                        gba.loadROM(buffer);
                        romLoaded = true;
                        console.log(`ROM loaded`);
                        onPause();
                    }
                };
                fileReader.readAsArrayBuffer(event.files[0]);
            }

            const onRun = () => {
                instructionTableState.pcOffset = 0;
                document.getElementById("instruction_table_warning").classList.remove("hidden");
                document.getElementById("instruction_table").classList.add("hidden");
                romLoaded = true;
                gba.run();
            }

            const onPause = () => {
                gba.pause();
                document.getElementById("instruction_table_warning").classList.add("hidden");
                document.getElementById("instruction_table").classList.remove("hidden");

                // Focus instruction list on PC on pause
                instructionTableState.activeAddress = gba.cpu.getGeneralRegister(15) - gba.cpu.instructionSize * 2;
                updateInstructionList();
            }

            const onReset = () => {
                gba.reset();
                document.getElementById("instruction_table_warning").classList.add("hidden");
                document.getElementById("instruction_table").classList.remove("hidden");
                romLoaded = false;
            }

            const onStep = () => {
                gba.runStep();
                instructionTableState.activeAddress = gba.cpu.getGeneralRegister(15) - gba.cpu.instructionSize * 2;
                instructionTableState.pcOffset = 0;
                updateInstructionList();
            }

            const updateInstructionList = () => {
                const pc = gba.cpu.getGeneralRegister(15) - gba.cpu.instructionSize * 2;
                const lines = window.UI.getInstructionTableLines(instructionTableState.activeAddress + instructionTableState.pcOffset * gba.cpu.instructionSize, 11, gba);

                const table = document.getElementById("instruction_table");
                table.replaceChildren([]);
                lines.forEach(line => {
                    const tr = document.createElement("tr");
                    if (line.address === pc) {
                        tr.style = "background-color: #4287f5;";
                    }

                    const breakPoint = document.createElement("td");
                    breakPoint.innerHTML = "O";
                    breakPoint.style = "width: 5%;";

                    const address = document.createElement("td");
                    address.innerHTML = `0x${line.address.toString(16).padStart(8, '0')}`;
                    address.style = "width: 20%;";

                    const instruction = document.createElement("td");
                    instruction.innerHTML = `0x${line.instruction.toString(16).padStart(gba.cpu.operatingMode === "ARM" ? 8 : 4, '0')}`;
                    instruction.style = "width: 20%;";

                    const text = document.createElement("td");
                    text.innerHTML = line.text.toLowerCase();
                    text.style = "width: 50%;";

                    tr.appendChild(breakPoint);
                    tr.appendChild(address);
                    tr.appendChild(instruction);
                    tr.appendChild(text);
                    table.appendChild(tr);
                });
            }

            window.onload = () => {
                gba = new window.GBA();
                gba.reset();

                document.getElementById("startButton").onclick = () => {
                    if (romLoaded) {
                        onRun();
                    } else {
                        console.warn("No rom loaded");
                    }
                };
                document.getElementById("resetButton").onclick = () => { onReset(); };
                document.getElementById("instruction_table").addEventListener("wheel", (event) => {
                    if (!instructionTableState.checkScroll) return;
                    instructionTableState.pcOffset += Math.sign(event.wheelDeltaY) * -1;
                    requestAnimationFrame(() => {
                        updateInstructionList();
                        instructionTableState.checkScroll = true;
                    });
                    instructionTableState.checkScroll = false;
                });

                document.getElementById("debug_reset_button").addEventListener("click", () => { onReset(); });
                document.getElementById("debug_run_button").addEventListener("click", () => { onRun(); });
                document.getElementById("debug_pause_button").addEventListener("click", () => { onPause(); });
                document.getElementById("debug_step_button").addEventListener("click", () => { onStep(); });
            }
        </script>
    </head>
    <body>
        <div id="container">
            <div style="margin-bottom: 20px;">
                <a href="https://github.com/SkylerRankin/ts-gba" style="color: #0398fc; text-decoration: none; font-size: 20px; font-weight: bold;">ts-gba</a>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <div id="canvas_container">
                    <canvas id="frame_0_canvas" width="480px" height="320px"></canvas>
                    <canvas id="frame_1_canvas" width="480px" height="320px" class="canvas_hidden"></canvas>
                </div>
                <div id="tab_container">
                    <div id="tab_row">
                        <div id="tab0" class="tab" onclick="onTabSelect(0)">Game</div>
                        <div id="tab1" class="tab tab_selected" onclick="onTabSelect(1)">CPU</div>
                        <div id="tab2" class="tab" onclick="onTabSelect(2)">PPU</div>
                    </div>
                    <div id="tab0_container" class="tab_content tab_hidden">
                        <div>
                            <input id="romInput" type="file" style="display: none !important;" onChange="onROMUpload(this)">
                            <button id='uploadButton' onClick="document.getElementById('romInput').click()"}>Upload ROM</button>
                            <button id="startButton">Start</button>
                            <button id="resetButton">Reset</button>
                        </div>
                        <div>
                            <table>
                                <tr>
                                    <td>FPS</td>
                                    <td><span id="fpsText">0</span></td>
                                </tr>
                                <tr>
                                    <td style="padding-right: 20px;">Last frame cycles</td>
                                    <td><span id="lastFrameCyclesText">0</span></td>
                                </tr>
                                <tr>
                                    <td>Last frame ms</td>
                                    <td><span id="lastFrameMSText">0</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div id="tab1_container" class="tab_content">
                        <div>
                            <div class="button" id="debug_reset_button">Reset</div>
                            <div class="button" id="debug_run_button">Run</div>
                            <div class="button" id="debug_pause_button">Pause</div>
                            <div class="button" id="debug_step_button">Step</div>
                        </div>
                        <div style="background-color: bisque;">instructions</div>
                        <table id="instruction_table" class="hidden"></table>
                        <div id="instruction_table_warning" class="hidden">Not shown while emulator is running</div>
                    </div>
                    <div id="tab2_container" class="tab_hidden tab_content">
                        tab 2, empty
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
